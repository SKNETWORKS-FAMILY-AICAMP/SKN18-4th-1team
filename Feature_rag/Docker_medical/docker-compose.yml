version: '3.8'  # Docker Compose 파일 버전

services:
  ############################################################
  # PostgreSQL + pgvector
  ############################################################
  postgres:
    image: pgvector/pgvector:pg16       # PostgreSQL 16 + pgvector 확장 기능 포함 이미지
    container_name: postgres_pgvector_medical   # 컨테이너 이름
    restart: always     
                     # 컨테이너 비정상 종료 시 항상 재시작
    environment:
      POSTGRES_DB: ${PGDATABASE:-medical_db}
      POSTGRES_USER: ${PGUSER:-medical}
      POSTGRES_PASSWORD: ${PGPASSWORD:-medical1234}
    ports:
      - "${PGPORT:-5432}:5432"     # 호스트 포트:컨테이너 포트 (기본 PostgreSQL 포트 5432)
      
    volumes:
      # PostgreSQL 데이터 영속화 (컨테이너 재시작 시에도 데이터 유지)
      - ./database:/var/lib/postgresql/data

      # 초기화 SQL 스크립트 자동 실행
      # docker-compose 실행 시 init.sql을 이용해 테이블 생성/pgvector 확장 자동 설치
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

    healthcheck:
      # PostgreSQL이 정상적으로 실행 중인지 확인
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]  # 환경변수로 접속 테스트
      interval: 10s    # 10초마다 헬스체크
      timeout: 5s      # 응답이 5초 안에 없으면 실패로 간주
      retries: 5       # 5회 시도 후에도 실패하면 unhealthy 상태로 표시
